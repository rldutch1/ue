SELECT INTO "nl:"
    patient = p.name_full_formatted
    ,updated_by = pr.name_full_formatted
    ,updated_on = epr.updt_dt_tm
    , phone_number =
    IF (findstring("(",ph.phone_num,1,0)=0
     AND findstring(")",ph.phone_num,1,0)=0) cnvtphone(ph.phone_num,ph.phone_format_cd,2)
    ELSE ph.phone_num
    ENDIF
    , phone_sort = cnvtalphanum(ph.phone_num), phone_type = uar_get_code_display(ph.phone_type_cd);,
;    sort_val = getecsortvalue(ph.phone_type_cd)
    ,epr.*
    FROM encntr_person_reltn epr,
     phone ph,
     person p,
     prsnl pr
    PLAN (epr
     WHERE epr.encntr_id in ([+encntr_id+]) ;encntrid
      AND epr.person_reltn_type_cd=1152.00    ;Emergency Contact ;emc_cd
      AND epr.related_person_id > 0.0
      AND epr.beg_effective_dt_tm < cnvtdatetime(sysdate)
      AND epr.end_effective_dt_tm >= cnvtdatetime(sysdate)
      AND epr.active_ind=1)
     JOIN (p
     WHERE p.person_id=epr.related_person_id)
     JOIN (ph
     WHERE (ph.parent_entity_id= Outerjoin(epr.related_person_id))
      AND (ph.parent_entity_name= Outerjoin("PERSON"))
      AND (ph.beg_effective_dt_tm<= Outerjoin(cnvtdatetime(sysdate)))
      AND (ph.end_effective_dt_tm>= Outerjoin(cnvtdatetime(sysdate)))
      AND (ph.active_ind= Outerjoin(1)) )
     JOIN pr
     WHERE pr.person_id = epr.updt_id
     AND pr.active_ind = 1
    ORDER BY p.person_id, ph.parent_entity_id, epr.priority_seq,
     phone_type, ph.phone_type_seq,
     phone_sort
WITH UAR_CODE(D), FORMAT(DATE,";;Q"), TIME=60
